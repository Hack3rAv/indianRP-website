<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forum Thread | Indian Roleplay</title>

    <!-- CORE STYLES -->
    <link rel="stylesheet" href="/assets/css/core.css" />
    <link rel="stylesheet" href="/assets/css/layout.css" />
    <link rel="stylesheet" href="/assets/css/components.css" />
    <link rel="stylesheet" href="/assets/css/forum.css" />

    <!-- ADMIN FORUM STYLES -->
    <link rel="stylesheet" href="/assets/css/forum-admin.css" />
</head>
<body>

<!-- ================= HEADER ================= -->
<header>
    <div class="nav-container">
        <div class="logo">INDIAN <span>RP</span></div>

        <nav>
            <ul class="nav-links">
                <li><a href="/index.html">HOME</a></li>
                <li><a href="/pages/features.html">FEATURES</a></li>
                <li><a href="/pages/wiki.html">WIKI</a></li>
                <li><a href="/pages/rules.html">RULES</a></li>
                <li><a href="/pages/community.html">COMMUNITY</a></li>
                <li><a href="/pages/forum/index.html" class="active">FORUM</a></li>
            </ul>
        </nav>

        <div class="header-actions">
            <button class="btn-mega" disabled>LOGIN</button>
        </div>
    </div>
</header>

<main id="app-content">

    <!-- ================= THREAD HEADER ================= -->
    <section class="forum-thread-header">
        <div class="container">
            <span class="thread-badge open" id="threadBadge">OPEN</span>
            <h1 class="thread-title" id="threadTitle"></h1>

            <p class="thread-meta" id="threadMeta"></p>

        </div>
    </section>

    <!-- ================= THREAD POSTS ================= -->
    <section class="forum-thread-content">
    <div class="container" id="postsContainer"></div>
    </section>


    <!-- ================= REPLY BOX ================= -->
    <section class="forum-reply" id="replyBox">
        <div class="container">
            <h3>Post a Reply</h3>

            <textarea
                class="forum-textarea"
                placeholder="Write your reply here..."
                disabled
            ></textarea>

            <p class="reply-note">
                Login required to reply.
            </p>
        </div>
    </section>

    <!-- ================= MOVE THREAD MODAL ================= -->
<div class="modal hidden" id="moveModal">

    <div class="modal-box">
        <h3>Move Thread</h3>

        <div class="form-group">
            <label>New Category</label>
            <select id="moveCategory">
                <option value="discussion">Discussion</option>
                <option value="support">Support</option>
                <option value="application">Application</option>
                <option value="appeal">Appeal</option>
                <option value="archive">Archive</option>
            </select>
        </div>

        <div class="form-group">
            <label>Reason (Required)</label>
            <textarea
                id="moveReason"
                placeholder="Explain why this thread is being moved..."
            ></textarea>
        </div>

        <div class="modal-actions">
            <button class="btn-outline" id="cancelMove">Cancel</button>
            <button class="btn-mega" id="confirmMove">Move Thread</button>
        </div>

    </div>

</div>


</main>













<!-- ================= PERMISSIONS + ADMIN LOGIC ================= -->
<script>
/* ================= MOCK DATA (BACKEND WILL REPLACE) ================= */
const CURRENT_USER_ROLE = "support";     // guest | user | support | appeal | admin
const THREAD_TYPE = "support";            // discussion | support | application | appeal
let THREAD_STATUS = "open";               // open | closed | locked

/* ================= PERMISSION MATRIX ================= */
const PERMISSIONS = {
    guest:   { view:["discussion"], reply:[], admin:false },
    user:    { view:["discussion","support"], reply:["discussion","support"], admin:false },
    support: { view:["discussion","support"], reply:["discussion","support"], admin:true },
    appeal:  { view:["discussion","appeal"], reply:["discussion","appeal"], admin:true },
    admin:   { view:["discussion","support","application","appeal"], reply:["all"], admin:true }
};

/* ================= ELEMENTS ================= */
const adminTools = document.getElementById("adminTools");
const replyBox   = document.getElementById("replyBox");
const badge      = document.getElementById("threadBadge");
const page       = document.querySelector("main");

/* ================= VIEW PERMISSION ================= */
if (!PERMISSIONS[CURRENT_USER_ROLE].view.includes(THREAD_TYPE)) {
    document.body.innerHTML = "<h1 style='padding:40px'>403 — Forbidden</h1>";
}

/* ================= ADMIN TOOLS ================= */
if (PERMISSIONS[CURRENT_USER_ROLE].admin) {
    adminTools.classList.remove("hidden");
}

/* ================= REPLY PERMISSION ================= */
if (
    THREAD_STATUS !== "open" ||
    (!PERMISSIONS[CURRENT_USER_ROLE].reply.includes(THREAD_TYPE)
     && !PERMISSIONS[CURRENT_USER_ROLE].reply.includes("all"))
) {
    replyBox.style.display = "none";
}

/* ================= STATUS HANDLER ================= */
function setStatus(status) {
    THREAD_STATUS = status;

    badge.className = "thread-badge " + status;
    badge.textContent = status.toUpperCase();

    page.classList.remove("thread-open","thread-closed","thread-locked");
    page.classList.add("thread-" + status);

    if (status !== "open") replyBox.style.display = "none";
}

/* ================= ADMIN ACTIONS ================= */
document.querySelectorAll(".admin-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const action = btn.dataset.action;
        if (action === "close") setStatus("closed");
        if (action === "lock") setStatus("locked");
        if (action === "status") setStatus("open");
    });
});
</script>

<script>
/* ================= MOVE THREAD ================= */
const moveBtn = document.querySelector('[data-action="move"]');
const modal = document.getElementById("moveModal");
const cancelBtn = document.getElementById("cancelMove");
const confirmBtn = document.getElementById("confirmMove");

moveBtn?.addEventListener("click", () => {
    modal.classList.remove("hidden");
});

cancelBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
});

confirmBtn.addEventListener("click", () => {
    const category = document.getElementById("moveCategory").value;
    const reason = document.getElementById("moveReason").value.trim();

    if (!reason) {
        alert("Reason is required.");
        return;
    }

    // Update thread meta (frontend)
    document.querySelector(".thread-meta").innerHTML =
        `Moved by <strong>Admin</strong> · ${category.toUpperCase()}`;

    // Insert system post
    insertSystemPost(category, reason);

    modal.classList.add("hidden");
});

/* ================= SYSTEM POST ================= */
function insertSystemPost(category, reason) {
    const container = document.querySelector(".forum-thread-content .container");

    const post = document.createElement("div");
    post.className = "forum-post admin system";

    post.innerHTML = `
        <div class="post-author">
            <strong>SYSTEM</strong>
            <span class="role admin">ADMIN PANEL</span>
            <span class="admin-badge">MOVED</span>
        </div>

        <div class="post-body">
            <p>
                This thread was moved to <strong>${category}</strong>.
            </p>
            <p>
                Reason: ${reason}
            </p>
        </div>

        <div class="post-footer">
            System Action · Just now
        </div>
    `;

    container.appendChild(post);
}
</script>


</body>

<script>
(async function () {
    const params = new URLSearchParams(window.location.search);
    const threadId = params.get("id");

    if (!threadId) {
        document.body.innerHTML = "<h2 style='padding:40px'>Invalid thread</h2>";
        return;
    }

    try {
        const res = await fetch(
            `http://localhost:3000/api/forum/threads/${threadId}`
        );
        const data = await res.json();

        if (!data.success) {
            throw new Error("Thread not found");
        }

        const { thread, posts } = data;

        // ---------- HEADER ----------
        document.getElementById("threadTitle").textContent = thread.title;

        document.getElementById("threadMeta").innerHTML = `
            Posted by <strong>${thread.username}</strong> ·
            ${new Date(thread.created_at).toLocaleString()}
        `;

        const badge = document.getElementById("threadBadge");
        badge.textContent = thread.status.toUpperCase();
        badge.className = "thread-badge " + thread.status;

        // ---------- POSTS ----------
        const container = document.getElementById("postsContainer");
        container.innerHTML = "";

        posts.forEach(post => {
            const div = document.createElement("div");
            div.className = "forum-post";

            div.innerHTML = `
                <div class="post-author">
                    <strong>${post.username}</strong>
                    <span class="role ${post.post_type}">
                        ${post.post_type.toUpperCase()}
                    </span>
                </div>

                <div class="post-body">
                    ${post.content
                        .split("\n")
                        .map(p => `<p>${p}</p>`)
                        .join("")}
                </div>

                <div class="post-footer">
                    Posted · ${new Date(post.created_at).toLocaleString()}
                </div>
            `;

            container.appendChild(div);
        });

    } catch (err) {
        console.error(err);
        document.body.innerHTML =
            "<h2 style='padding:40px'>Failed to load thread</h2>";
    }
})();
</script>



</html>
